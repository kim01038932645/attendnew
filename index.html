<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT D조 출석부 & 랭킹 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app" class="min-h-screen max-w-lg mx-auto shadow-2xl relative border-x border-gray-200 flex flex-col bg-slate-50">
        <!-- 로딩 화면 -->
        <div id="loading-screen" class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center gap-4">
            <div class="animate-spin text-blue-600">
                <i data-lucide="loader-2" size="40"></i>
            </div>
            <p class="font-bold text-slate-400 text-sm">시스템 초기화 중...</p>
        </div>

        <!-- 헤더 -->
        <header class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 z-30 shadow-lg">
            <div class="flex items-center gap-2 cursor-pointer" onclick="router.go('home')">
                <i data-lucide="activity" size="20"></i>
                <h1 class="font-black text-lg tracking-tighter">SRT D조</h1>
            </div>
            <button onclick="admin.showModal()" class="p-2 hover:bg-white/10 rounded-full transition">
                <i data-lucide="settings" size="20"></i>
            </button>
        </header>

        <!-- 메인 컨텐츠 영역 -->
        <main id="main-content" class="flex-1 overflow-y-auto p-3 space-y-4"></main>

        <!-- 푸터 -->
        <footer class="p-4 text-center text-[10px] text-slate-300 font-bold bg-slate-50 border-t border-slate-100">
            SRT D-Group Training System © 2026
        </footer>

        <!-- 모달: 관리자 암호 -->
        <div id="admin-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
            <div class="bg-white w-full max-w-xs rounded-[3rem] p-8 shadow-2xl space-y-6">
                <div class="flex flex-col items-center gap-3">
                    <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">
                        <i data-lucide="lock" size="24"></i>
                    </div>
                    <h3 class="font-black text-xl text-slate-800">관리자 암호</h3>
                    <p class="text-[11px] text-slate-400 font-bold">권한이 필요합니다.</p>
                </div>
                <div class="space-y-2">
                    <input type="password" id="admin-password-input" class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 text-center text-2xl font-black outline-none focus:border-blue-100 transition shadow-inner text-blue-600">
                    <p id="admin-error-msg" class="hidden text-center text-[10px] text-red-500 font-bold">암호가 일치하지 않습니다.</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="admin.hideModal()" class="flex-1 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm active:scale-95 transition-all">취소</button>
                    <button onclick="admin.verify()" class="flex-2 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg shadow-blue-100 active:scale-95 transition-all px-8">확인</button>
                </div>
            </div>
        </div>

        <!-- 모달: 기록 수정 -->
        <div id="edit-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
            <div id="edit-modal-content" class="bg-white w-full max-w-xs rounded-[3rem] p-8 shadow-2xl space-y-6"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- [설정 및 초기화] ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-group-attendance';

        const INITIAL_MEMBERS = [
            "강동현", "강동훈", "송채한", "김미화", "김재산", "김찬석", "김한나", 
            "류지찬", "박성환", "박종봉", "소병득", "서정화", "신영섭", "안지훈", 
            "오한천", "이승준", "이용구", "정덕수", "주효석", "서인수", "박창선", "김병식"
        ];

        // --- [상태 관리] ---
        let state = {
            user: null,
            members: [],
            logs: {},
            config: { currentMonth: "2026-01" },
            currentView: 'home',
            selectedUser: null,
            searchTerm: '',
            viewMonth: "2026-01"
        };

        // --- [인증 로직 (Rule 3)] ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                initDataSync();
            }
        });

        // --- [데이터 동기화 (Rule 1)] ---
        function initDataSync() {
            const membersColl = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            const logsColl = collection(db, 'artifacts', appId, 'public', 'data', 'logs');
            const configDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'appConfig', 'settings');

            onSnapshot(membersColl, (snapshot) => {
                state.members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (state.members.length === 0) {
                    INITIAL_MEMBERS.forEach(name => setDoc(doc(membersColl, name), { name }));
                }
                render();
                document.getElementById('loading-screen').classList.add('hidden');
            }, (err) => console.error("Members error:", err));

            onSnapshot(logsColl, (snapshot) => {
                snapshot.forEach(doc => state.logs[doc.id] = doc.data());
                render();
            });

            onSnapshot(configDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    state.config = docSnap.data();
                    state.viewMonth = state.config.currentMonth;
                } else {
                    setDoc(configDocRef, { currentMonth: "2026-01" });
                }
                render();
            });
        }

        // --- [비즈니스 로직] ---
        window.actions = {
            updateLog: async (userName, date, field, value) => {
                if (!state.user) return;
                const logRef = doc(db, 'artifacts', appId, 'public', 'data', 'logs', userName);
                const currentData = state.logs[userName] || {};
                await setDoc(logRef, {
                    ...currentData,
                    [date]: { ...(currentData[date] || {}), [field]: value }
                });
                render();
                // 팝업 내부 데이터 갱신을 위해 현재 열린 팝업이 있다면 다시 그림
                if (field === 'attended') {
                    const editDay = JSON.parse(document.getElementById('edit-day-data').value);
                    editDay.attended = value;
                    ui.showEditModal(editDay);
                }
            },
            addMember: async (name) => {
                if (!name || !state.user) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', name), { name });
            },
            deleteMember: async (id, name) => {
                if (!state.user) return;
                if (!confirm(`${name}님을 삭제하시겠습니까?`)) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'members', id));
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'logs', name));
            },
            setAppMonth: async (month) => {
                if (!state.user) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'appConfig', 'settings'), { currentMonth: month });
            }
        };

        // --- [라우팅 및 UI 제어] ---
        window.router = {
            go: (view, data = null) => {
                state.currentView = view;
                state.selectedUser = data;
                if (view === 'user') state.viewMonth = state.config.currentMonth;
                render();
            }
        };

        window.admin = {
            showModal: () => {
                document.getElementById('admin-password-input').value = '';
                document.getElementById('admin-error-msg').classList.add('hidden');
                document.getElementById('admin-modal').classList.remove('hidden');
            },
            hideModal: () => document.getElementById('admin-modal').classList.add('hidden'),
            verify: () => {
                const pass = document.getElementById('admin-password-input').value;
                if (pass === '1004') {
                    admin.hideModal();
                    router.go('admin');
                } else {
                    document.getElementById('admin-error-msg').classList.remove('hidden');
                }
            }
        };

        window.ui = {
            showEditModal: (dayObj) => {
                const modal = document.getElementById('edit-modal');
                const content = document.getElementById('edit-modal-content');
                const userLog = state.logs[state.selectedUser] || {};
                const currentLog = userLog[dayObj.date] || {};

                content.innerHTML = `
                    <input type="hidden" id="edit-day-data" value='${JSON.stringify(dayObj)}'>
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-xl text-slate-800">${dayObj.day}일 훈련 기록</h3>
                        <button onclick="ui.hideEditModal()" class="text-slate-300 hover:text-slate-500"><i data-lucide="x" size="24"></i></button>
                    </div>
                    ${(dayObj.isWed || dayObj.isSun) ? `
                        <button onclick="actions.updateLog('${state.selectedUser}', '${dayObj.date}', 'attended', ${!currentLog.attended})"
                                class="w-full py-4 rounded-2xl font-black text-sm flex items-center justify-center gap-2 border-2 transition-all ${currentLog.attended ? 'bg-green-500 border-green-500 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-300'}">
                            <i data-lucide="check-circle-2" size="20"></i> 공식 훈련 출석 체크
                        </button>
                    ` : ''}
                    <div class="space-y-3">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">달린 거리 (km)</label>
                        <input type="number" id="distance-input" step="0.1" inputMode="decimal" 
                               class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 text-center text-3xl font-black text-blue-600 outline-none focus:border-blue-100 shadow-inner"
                               value="${currentLog.distance || ''}"
                               onchange="actions.updateLog('${state.selectedUser}', '${dayObj.date}', 'distance', this.value)">
                    </div>
                    <button onclick="ui.hideEditModal()" class="w-full py-4 bg-slate-900 text-white rounded-2xl font-black text-base shadow-xl active:scale-95 transition-all">확인</button>
                `;
                modal.classList.remove('hidden');
                lucide.createIcons();
            },
            hideEditModal: () => document.getElementById('edit-modal').classList.add('hidden')
        };

        // --- [렌더링 엔진] ---
        function render() {
            const container = document.getElementById('main-content');
            container.innerHTML = '';

            if (state.currentView === 'home') renderHome(container);
            else if (state.currentView === 'user') renderUser(container);
            else if (state.currentView === 'admin') renderAdmin(container);
            
            lucide.createIcons();
        }

        function renderHome(container) {
            const filtered = state.members
                .filter(m => m.name.includes(state.searchTerm))
                .sort((a, b) => a.name.localeCompare(b.name));

            const rankings = calculateRankings();

            container.innerHTML = `
                <div class="animate-fade-in space-y-4">
                    <section class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-sm font-black text-slate-800 flex items-center gap-2">
                                <i data-lucide="user" size="16" class="text-blue-500"></i> 훈련 입실 체크
                            </h2>
                            <div class="relative">
                                <input type="text" placeholder="이름 검색" id="search-input"
                                       class="pl-8 pr-3 py-1.5 bg-slate-100 rounded-full text-[11px] font-bold outline-none focus:ring-2 focus:ring-blue-400 w-32 transition-all"
                                       value="${state.searchTerm}">
                                <i data-lucide="search" size="12" class="absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-4 gap-2 max-h-[450px] overflow-y-auto pr-1 custom-scrollbar">
                            ${filtered.map(m => `
                                <button onclick="router.go('user', '${m.name}')" class="flex items-center justify-center py-3 rounded-xl border border-slate-50 bg-slate-50 hover:bg-blue-600 hover:text-white hover:shadow-md transition-all active:scale-95 text-[12px] font-black text-slate-600">
                                    ${m.name}
                                </button>
                            `).join('')}
                        </div>
                    </section>
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        ${renderRankingCard("거리 TOP 8", "trophy", rankings.distance, "k", "distance")}
                        ${renderRankingCard("출석 TOP 8", "check-circle-2", rankings.attendance, "회", "attendance")}
                    </div>
                </div>
            `;

            document.getElementById('search-input').addEventListener('input', (e) => {
                state.searchTerm = e.target.value;
                render();
            });
        }

        function renderUser(container) {
            const userLog = state.logs[state.selectedUser] || {};
            const stats = calculateUserStats(userLog, state.viewMonth);
            const calendar = generateCalendarData(userLog, state.viewMonth);

            container.innerHTML = `
                <div class="animate-fade-in space-y-4">
                    <div class="flex items-center gap-3 bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                        <button onclick="router.go('home')" class="p-1.5 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i data-lucide="chevron-left" size="18"></i></button>
                        <h2 class="text-lg font-black text-slate-800 tracking-tight">${state.selectedUser}님 기록</h2>
                    </div>
                    <div class="grid grid-cols-2 gap-3 bg-blue-600 p-6 rounded-[2.5rem] text-white shadow-xl text-center">
                        <div class="border-r border-white/20">
                            <p class="text-[10px] opacity-60 font-black mb-1">월간 거리</p>
                            <p class="text-3xl font-black">${stats.dist.toFixed(1)}<span class="text-xs ml-0.5">km</span></p>
                        </div>
                        <div>
                            <p class="text-[10px] opacity-60 font-black mb-1">월간 출석</p>
                            <p class="text-3xl font-black">${stats.att}<span class="text-xs ml-0.5">회</span></p>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center justify-between mb-5 px-2">
                            <button onclick="changeViewMonth(-1)" class="p-1 hover:bg-slate-50 rounded-full"><i data-lucide="chevron-left" size="20"></i></button>
                            <span class="font-black text-sm text-slate-700">${state.viewMonth.replace('-', '년 ')}월</span>
                            <button onclick="changeViewMonth(1)" class="p-1 hover:bg-slate-50 rounded-full"><i data-lucide="chevron-right" size="20"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-2">
                            ${calendar.map(d => `
                                <button ${d.empty ? 'disabled' : `onclick='ui.showEditModal(${JSON.stringify(d)})'`} 
                                        class="aspect-square rounded-2xl flex flex-col items-center justify-center relative text-[11px] font-black transition-all active:scale-90 
                                               ${d.empty ? '' : 'bg-slate-50 border border-slate-50 hover:border-blue-200'} 
                                               ${d.attended ? 'bg-green-100 border-green-200 text-green-700 shadow-inner' : ''} 
                                               ${d.isSun ? 'text-red-400' : d.isWed ? 'text-blue-500' : 'text-slate-600'}">
                                    ${!d.empty ? `
                                        <span>${d.day}</span>
                                        ${d.distance > 0 ? `<span class="text-[8px] text-blue-500 absolute bottom-1 font-bold">${Math.floor(d.distance)}</span>` : ''}
                                        ${d.attended ? `<div class="absolute top-1.5 right-1.5 w-1.5 h-1.5 bg-green-500 rounded-full"></div>` : ''}
                                    ` : ''}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAdmin(container) {
            container.innerHTML = `
                <div class="animate-fade-in space-y-4">
                    <div class="flex items-center gap-3 bg-white p-4 rounded-3xl shadow-sm border border-slate-100">
                        <button onclick="router.go('home')" class="p-1.5 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200"><i data-lucide="chevron-left" size="18"></i></button>
                        <h2 class="text-lg font-black text-slate-800 tracking-tighter">관리 설정</h2>
                    </div>
                    <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h3 class="text-[10px] font-black text-slate-400 mb-4 uppercase flex items-center gap-2"><i data-lucide="calendar" size="14"></i> 랭킹 기준 월 설정</h3>
                        <div class="grid grid-cols-4 gap-2">
                            ${["2026-01", "2026-02", "2026-03", "2026-04", "2026-05", "2026-06", "2026-07"].map(m => `
                                <button onclick="actions.setAppMonth('${m}')" class="text-[11px] py-3 rounded-2xl font-black border transition-all ${state.config.currentMonth === m ? 'bg-blue-600 border-blue-600 text-white shadow-lg shadow-blue-100' : 'bg-slate-50 border-transparent text-slate-400'}">
                                    ${parseInt(m.split('-')[1])}월
                                </button>
                            `).join('')}
                        </div>
                    </section>
                    <section class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h3 class="text-[10px] font-black text-slate-400 mb-4 uppercase flex items-center gap-2"><i data-lucide="user" size="14"></i> 멤버 명단 (${state.members.length})</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-member-name" placeholder="새 멤버 이름" class="flex-1 bg-slate-50 border-2 border-slate-50 rounded-2xl px-4 py-3 text-sm font-bold outline-none focus:border-blue-100">
                            <button onclick="const n = document.getElementById('new-member-name').value; actions.addMember(n); document.getElementById('new-member-name').value='';" class="bg-blue-600 text-white px-5 rounded-2xl font-black text-sm active:scale-95">추가</button>
                        </div>
                        <div class="space-y-2 max-h-[300px] overflow-y-auto pr-1 custom-scrollbar">
                            ${state.members.sort((a,b)=>a.name.localeCompare(b.name)).map(m => `
                                <div class="flex justify-between items-center bg-slate-50/50 p-4 rounded-2xl border border-slate-50">
                                    <span class="font-black text-slate-600 text-sm">${m.name}</span>
                                    <button onclick="actions.deleteMember('${m.id}', '${m.name}')" class="text-slate-300 hover:text-red-500 p-1"><i data-lucide="trash-2" size="16"></i></button>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                </div>
            `;
        }

        // --- [헬퍼 함수] ---
        function calculateRankings() {
            const month = state.config.currentMonth;
            const stats = state.members.map(m => {
                const uLogs = state.logs[m.name] || {};
                let dist = 0, att = 0;
                Object.entries(uLogs).forEach(([date, data]) => {
                    if (date.startsWith(month)) {
                        dist += parseFloat(data.distance || 0);
                        if (data.attended) att++;
                    }
                });
                return { name: m.name, distance: dist, attendance: att };
            });
            return {
                distance: [...stats].sort((a, b) => b.distance - a.distance).slice(0, 8),
                attendance: [...stats].sort((a, b) => b.attendance - a.attendance).slice(0, 8)
            };
        }

        function renderRankingCard(title, icon, data, unit, type) {
            return `
                <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 flex flex-col">
                    <div class="flex flex-col gap-0.5 mb-3 border-b border-slate-50 pb-2">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="${icon}" size="14" class="${type==='distance'?'text-yellow-500':'text-green-500'}"></i>
                            <h3 class="font-black text-slate-800 text-[12px] truncate tracking-tighter">${title}</h3>
                        </div>
                        <span class="text-[10px] font-black text-blue-500 opacity-60 uppercase tracking-wider">${state.config.currentMonth.split('-')[1]}월</span>
                    </div>
                    <div class="space-y-2.5 flex-1">
                        ${data.map((r, i) => `
                            <div class="flex justify-between items-center text-[11px]">
                                <div class="flex items-center gap-2 min-w-0">
                                    <span class="w-4 h-4 flex items-center justify-center rounded-lg text-[9px] font-black shrink-0 ${i===0?'bg-yellow-400 text-white shadow-sm':i===1?'bg-slate-200 text-slate-600':i===2?'bg-orange-200 text-white':'bg-slate-50 text-slate-300'}">${i+1}</span>
                                    <span class="font-bold text-slate-700 truncate">${r.name}</span>
                                </div>
                                <div class="flex items-baseline gap-0.5 shrink-0 ml-1">
                                    <span class="font-black ${type==='distance'?'text-blue-600':'text-green-600'}">${type==='distance'?Math.floor(r.distance):r.attendance}</span>
                                    <span class="text-[8px] text-slate-300 font-bold">${unit}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function calculateUserStats(userLog, month) {
            let d = 0, a = 0;
            Object.entries(userLog).forEach(([date, val]) => {
                if (date.startsWith(month)) {
                    d += parseFloat(val.distance || 0);
                    if (val.attended) a++;
                }
            });
            return { dist: d, att: a };
        }

        function generateCalendarData(userLog, month) {
            const [y, m] = month.split('-').map(Number);
            const firstDay = new Date(y, m - 1, 1).getDay();
            const lastDate = new Date(y, m, 0).getDate();
            const days = [];
            for (let i = 0; i < firstDay; i++) days.push({ empty: true });
            for (let i = 1; i <= lastDate; i++) {
                const dateStr = `${y}-${String(m).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const d = new Date(y, m - 1, i);
                days.push({ 
                    day: i, 
                    date: dateStr, 
                    isWed: d.getDay() === 3, 
                    isSun: d.getDay() === 0, 
                    ...(userLog[dateStr] || {}) 
                });
            }
            return days;
        }

        window.changeViewMonth = (delta) => {
            const [y, m] = state.viewMonth.split('-').map(Number);
            const date = new Date(y, m - 1 + delta, 1);
            state.viewMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            render();
        };

        initAuth();
    </script>
</body>
</html>