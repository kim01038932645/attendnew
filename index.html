<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRT D조 출석부</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50">
    <div id="app" class="min-h-screen max-w-lg mx-auto shadow-2xl relative border-x border-gray-200 flex flex-col bg-slate-50">
        <!-- 초기 로딩 화면 -->
        <div id="loading-screen" class="fixed inset-0 z-[200] bg-white flex flex-col items-center justify-center gap-4">
            <div class="animate-spin text-blue-600"><i data-lucide="loader-2" size="40"></i></div>
            <p id="loading-text" class="font-bold text-slate-400 text-sm text-center px-6">
                시스템 초기화 중...<br>
                <span class="text-[10px] font-normal mt-2 block">배포 시 Firebase 설정이 필요합니다.</span>
            </p>
        </div>

        <header class="bg-blue-600 text-white p-4 flex justify-between items-center sticky top-0 z-30 shadow-lg">
            <div class="flex items-center gap-2 cursor-pointer" onclick="router.go('home')">
                <i data-lucide="activity" size="20"></i>
                <h1 class="font-black text-lg tracking-tighter">SRT D조</h1>
            </div>
            <button onclick="admin.showModal()" class="p-2 hover:bg-white/10 rounded-full transition">
                <i data-lucide="settings" size="20"></i>
            </button>
        </header>

        <main id="main-content" class="flex-1 overflow-y-auto p-3 space-y-4"></main>

        <!-- 관리자 모달 -->
        <div id="admin-modal" class="hidden fixed inset-0 z-[110] flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
            <div class="bg-white w-full max-w-xs rounded-[3rem] p-8 shadow-2xl space-y-6 text-center">
                <h3 class="font-black text-xl text-slate-800">관리자 확인</h3>
                <input type="password" id="admin-password-input" class="w-full bg-slate-50 border-2 border-slate-50 rounded-2xl p-4 text-center text-2xl font-black outline-none focus:border-blue-100 shadow-inner">
                <div class="flex gap-2">
                    <button onclick="admin.hideModal()" class="flex-1 py-4 bg-slate-100 text-slate-400 rounded-2xl font-black text-sm">취소</button>
                    <button onclick="admin.verify()" class="flex-2 py-4 bg-blue-600 text-white rounded-2xl font-black text-sm shadow-lg px-8">확인</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * 배포 에러 해결을 위한 중요 가이드:
         * 1. 아래 YOUR_... 부분에 본인의 Firebase 콘솔 설정값을 넣으세요.
         * 2. Canvas 환경에서는 주입된 값을 사용하고, 배포 환경에서는 하드코딩된 값을 사용하도록 로직을 수정했습니다.
         */
        const myFirebaseConfig = {
            apiKey: "AIzaSyBBP8vP90bOisbNlDpsp64k3hxLZw7x2JE",
            authDomain: "attendnew-63c66.firebaseapp.com",
            projectId: "attendnew-63c66",
            storageBucket: "attendnew-63c66.firebasestorage.app",
            messagingSenderId: "992717620682",
            appId: "1:992717620682:web:5ee93256b2a5172d72fb33"
        };

        // 안전한 Config 가져오기 (배포 환경 호환)
        let firebaseConfig;
        try {
            // Canvas 환경 변수가 있는지 체크
            const envConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
            firebaseConfig = envConfig ? JSON.parse(envConfig) : myFirebaseConfig;
        } catch (e) {
            firebaseConfig = myFirebaseConfig;
        }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-group-v1';

        // 상태 및 초기 데이터
        let state = {
            user: null,
            members: [],
            logs: {},
            config: { currentMonth: new Date().toISOString().slice(0, 7) },
            currentView: 'home',
            searchTerm: '',
            viewMonth: new Date().toISOString().slice(0, 7)
        };

        // 초기 인증
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth error:", error);
                document.getElementById('loading-text').innerHTML = "인증 실패: Firebase 설정을 확인하세요.";
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                initDataSync();
            }
        });

        function initDataSync() {
            if (!state.user) return;
            const membersColl = collection(db, 'artifacts', appId, 'public', 'data', 'members');
            const logsColl = collection(db, 'artifacts', appId, 'public', 'data', 'logs');
            
            onSnapshot(membersColl, (snap) => {
                state.members = snap.docs.map(d => d.data());
                render();
                document.getElementById('loading-screen').classList.add('hidden');
            }, (err) => {
                document.getElementById('loading-text').innerText = "데이터 로드 권한 오류 (Rules 확인)";
            });

            onSnapshot(logsColl, (snap) => {
                snap.forEach(d => state.logs[d.id] = d.data());
                render();
            });
        }

        // 라우팅 및 렌더링 (축약)
        window.router = { go: (v) => { state.currentView = v; render(); } };
        window.admin = {
            showModal: () => document.getElementById('admin-modal').classList.remove('hidden'),
            hideModal: () => document.getElementById('admin-modal').classList.add('hidden'),
            verify: () => {
                if(document.getElementById('admin-password-input').value === '1004') router.go('admin');
                admin.hideModal();
            }
        };

        function render() {
            const main = document.getElementById('main-content');
            main.innerHTML = `<div class="p-8 text-center text-slate-400 font-bold">시스템 작동 중...<br>${state.members.length}명의 멤버 로드됨</div>`;
            lucide.createIcons();
        }

        initAuth();
    </script>
</body>
</html>
