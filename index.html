<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRT Dì¡° ì¶œì„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.75rem; transition: all 0.2s; position: relative; border: 1px solid transparent; }
        .active-day { background-color: #f8fafc; border-color: #f1f5f9; cursor: pointer; }
        .active-day:active { background-color: #f1f5f9; transform: scale(0.95); }
        .training-day { font-weight: 800; color: #1d4ed8; background-color: #eff6ff; border-color: #bfdbfe; }
        .training-day::after { content: 'â€¢'; position: absolute; top: 2px; right: 4px; color: #3b82f6; font-size: 14px; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative">
        
        <!-- ê°•ì œ ì´ˆê¸° ë¡œë”© í™”ë©´ (ìµœëŒ€ 1.5ì´ˆ í›„ ìë™ ì†Œë©¸) -->
        <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center transition-opacity duration-500">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
                <p class="mt-4 text-slate-500 font-bold text-sm">ë°ì´í„° ì—°ê²° ì‹œë„ ì¤‘...</p>
            </div>
        </div>

        <!-- ë¡œê·¸ì¸/ì´ë¦„ ì„ íƒ í™”ë©´ -->
        <div id="screen-login" class="hidden p-8 flex flex-col items-center justify-center min-h-screen">
            <div class="text-center mb-10">
                <div class="inline-block p-4 bg-blue-50 rounded-full mb-4 text-3xl">ğŸƒâ€â™‚ï¸</div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter">SRT Dì¡°</h1>
                <p class="text-slate-400 font-bold mt-1 text-xs tracking-widest uppercase">2026 Season</p>
            </div>
            
            <div class="w-full space-y-4">
                <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                    <label class="block text-[10px] font-black mb-2 text-slate-400 uppercase ml-1">Member Name</label>
                    <select id="user-select" class="w-full p-4 bg-white border border-slate-200 rounded-2xl text-lg font-bold outline-none focus:ring-4 focus:ring-blue-100 transition-all appearance-none">
                        <option value="">ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <button id="btn-login" class="w-full bg-blue-600 text-white py-5 rounded-3xl text-xl font-black shadow-lg shadow-blue-200 active:scale-95 transition-all">
                    ì ‘ì†í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ë©”ì¸ í™”ë©´ -->
        <div id="screen-main" class="hidden">
            <header class="bg-slate-900 text-white p-8 rounded-b-[2.5rem] shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <p class="text-[10px] font-bold text-blue-400 uppercase mb-1">Crew Member</p>
                        <span id="display-name" class="text-2xl font-black"></span><span class="opacity-60 font-medium">ë‹˜</span>
                    </div>
                    <button id="btn-logout" class="bg-white/10 p-2.5 rounded-xl text-xs font-bold">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                        <p class="text-[9px] font-black text-blue-400 mb-1 uppercase">Distance</p>
                        <p class="text-xl font-black"><span id="stats-dist">0.0</span> <small class="text-[10px] opacity-40">km</small></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                        <p class="text-[9px] font-black text-emerald-400 mb-1 uppercase">Attendance</p>
                        <p class="text-xl font-black"><span id="stats-attr">0</span> <small class="text-[10px] opacity-40">íšŒ</small></p>
                    </div>
                </div>
            </header>

            <main class="p-5">
                <div class="flex items-center justify-between mb-6">
                    <button id="btn-prev-month" class="p-3 text-slate-400 font-bold">ã€ˆ</button>
                    <h2 id="calendar-title" class="text-xl font-black text-slate-800">2026ë…„ 1ì›”</h2>
                    <button id="btn-next-month" class="p-3 text-slate-400 font-bold">ã€‰</button>
                </div>

                <div class="calendar-grid mb-3 px-1 text-center">
                    <div class="text-[10px] font-black text-red-400">S</div>
                    <div class="text-[10px] font-black text-slate-300">M</div>
                    <div class="text-[10px] font-black text-slate-300">T</div>
                    <div class="text-[10px] font-black text-blue-400">W</div>
                    <div class="text-[10px] font-black text-slate-300">T</div>
                    <div class="text-[10px] font-black text-slate-300">F</div>
                    <div class="text-[10px] font-black text-slate-300">S</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>

                <!-- ì‹¤ì‹œê°„ ë­í‚¹ ì„¹ì…˜ -->
                <div class="mt-8">
                    <h3 class="text-xs font-black text-slate-800 uppercase tracking-widest mb-4 px-2">Crew Ranking (Jan)</h3>
                    <div class="grid grid-cols-1 gap-3" id="rank-list">
                        <!-- ë­í‚¹ ì•„ì´í…œ -->
                    </div>
                </div>
            </main>
        </div>

        <!-- ì…ë ¥ ëª¨ë‹¬ -->
        <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 z-[110] flex items-end justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-black text-blue-600 mb-1">DATE</p>
                        <h3 id="modal-date" class="text-xl font-black text-slate-800">2026-01-01</h3>
                    </div>
                    <button id="btn-close-modal" class="text-slate-300 text-xl">âœ•</button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-[10px] font-black mb-2 text-slate-400">RUNNING DISTANCE (KM)</label>
                        <input type="number" id="input-distance" step="0.1" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl text-2xl font-black outline-none focus:border-blue-500 focus:bg-white transition-all" placeholder="0.0">
                    </div>
                    <div id="attendance-area" class="flex items-center justify-between p-4 bg-blue-50/50 rounded-2xl border border-blue-100">
                        <span class="text-blue-900 font-bold text-sm">ì •ê¸° í›ˆë ¨ ì¶œì„ ì²´í¬</span>
                        <input type="checkbox" id="input-attendance" class="w-6 h-6 rounded-lg accent-blue-600">
                    </div>
                    <button id="btn-save" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-lg active:scale-95 transition-all">ê¸°ë¡ ì €ì¥í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ì„¤ì • (ì§ì ‘ ì…ë ¥ëœ ì •ë³´ ì‚¬ìš©)
        const firebaseConfig = {
            apiKey: "AIzaSyBBP8vP90bOisbNlDpsp64k3hxLZw7x2JE",
            authDomain: "attendnew-63c66.firebaseapp.com",
            projectId: "attendnew-63c66",
            storageBucket: "attendnew-63c66.firebasestorage.app",
            messagingSenderId: "992717620682",
            appId: "1:992717620682:web:5ee93256b2a5172d72fb33"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = "srt-d-crew-2026";

        const members = [
            "ê°•ë™í˜„", "ê°•ë™í›ˆ", "ì†¡ì±„í•œ", "ê¹€ë¯¸í™”", "ê¹€ì¬ì‚°", "ê¹€ì°¬ì„", "ê¹€í•œë‚˜", "ë¥˜ì§€ì°¬", 
            "ë°•ì„±í™˜", "ë°•ì¢…ë´‰", "ì†Œë³‘ë“", "ì„œì •í™”", "ì‹ ì˜ì„­", "ì•ˆì§€í›ˆ", "ì˜¤í•œì²œ", "ì´ìŠ¹ì¤€", 
            "ì´ìš©êµ¬", "ì •ë•ìˆ˜", "ì£¼íš¨ì„", "ì„œì¸ìˆ˜", "ë°•ì°½ì„ ", "ê¹€ë³‘ì‹"
        ].sort();

        // ìƒíƒœ
        let currentUser = localStorage.getItem('srt_user_name') || null;
        let currentMonth = new Date(2026, 0, 1);
        let selectedDateStr = "";
        let allRecords = []; 

        // ìš”ì†Œ
        const els = {
            loading: document.getElementById('loading-overlay'),
            loginScreen: document.getElementById('screen-login'),
            mainScreen: document.getElementById('screen-main'),
            userSelect: document.getElementById('user-select'),
            calendarTitle: document.getElementById('calendar-title'),
            calendarBody: document.getElementById('calendar-body'),
            rankList: document.getElementById('rank-list'),
            modal: document.getElementById('modal'),
            modalDate: document.getElementById('modal-date'),
            inputDistance: document.getElementById('input-distance'),
            inputAttendance: document.getElementById('input-attendance'),
            btnSave: document.getElementById('btn-save')
        };

        // ì´ˆê¸°í™”
        function init() {
            // ì´ë¦„ ì„ íƒ ì˜µì…˜ ì¶”ê°€
            members.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                els.userSelect.appendChild(opt);
            });

            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (currentUser && members.includes(currentUser)) {
                showMain();
            } else {
                showLogin();
            }

            // ë¡œë”© í™”ë©´ ê°•ì œ ì œê±° (ë°ì´í„° ì‘ë‹µì´ ëŠ¦ë”ë¼ë„ 1.5ì´ˆ í›„ì—” ì œê±°)
            setTimeout(() => {
                els.loading.style.opacity = '0';
                setTimeout(() => els.loading.classList.add('hidden'), 500);
            }, 1500);

            startSync();
        }

        function showLogin() {
            els.loginScreen.classList.remove('hidden');
            els.mainScreen.classList.add('hidden');
        }

        function showMain() {
            document.getElementById('display-name').textContent = currentUser;
            els.loginScreen.classList.add('hidden');
            els.mainScreen.classList.remove('hidden');
            renderCalendar();
        }

        // ì‹¤ì‹œê°„ ë™ê¸°í™”
        function startSync() {
            const pubRef = collection(db, 'artifacts', appId, 'public', 'data', 'records');
            onSnapshot(pubRef, (snap) => {
                allRecords = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderCalendar();
                renderRanking();
                updateStats();
            }, (err) => {
                console.warn("Firestore Error: ê¶Œí•œ ë¶€ì¡± ë˜ëŠ” ì—°ê²° ëŠê¹€", err);
            });
        }

        function renderRanking() {
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            const scores = {};
            members.forEach(m => scores[m] = { dist: 0, attr: 0 });

            allRecords.forEach(r => {
                const [name, ds] = r.id.split('_');
                if (!scores[name]) return;
                const d = new Date(ds);
                if (d.getFullYear() === y && d.getMonth() === m) {
                    scores[name].dist += parseFloat(r.distance || 0);
                    if (r.attendance) scores[name].attr++;
                }
            });

            const sorted = Object.entries(scores)
                .sort((a, b) => b[1].dist - a[1].dist)
                .slice(0, 10);

            els.rankList.innerHTML = sorted.map(([name, s], i) => `
                <div class="flex items-center justify-between bg-white p-4 rounded-2xl border border-slate-100">
                    <div class="flex items-center">
                        <span class="w-6 text-xs font-black text-slate-300">${i+1}</span>
                        <span class="font-bold text-slate-700">${name}</span>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="text-right">
                            <p class="text-[9px] font-black text-slate-300 uppercase leading-none mb-1">Dist</p>
                            <p class="text-sm font-black text-blue-600 leading-none">${s.dist.toFixed(1)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-[9px] font-black text-slate-300 uppercase leading-none mb-1">Attr</p>
                            <p class="text-sm font-black text-emerald-600 leading-none">${s.attr}</p>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-center text-slate-400 text-xs py-4">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }

        function updateStats() {
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            let dSum = 0, aSum = 0;
            allRecords.forEach(r => {
                if (r.userName === currentUser) {
                    const d = new Date(r.date);
                    if (d.getFullYear() === y && d.getMonth() === m) {
                        dSum += parseFloat(r.distance || 0);
                        if (r.attendance) aSum++;
                    }
                }
            });
            document.getElementById('stats-dist').textContent = dSum.toFixed(1);
            document.getElementById('stats-attr').textContent = aSum;
        }

        function renderCalendar() {
            els.calendarBody.innerHTML = '';
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < first; i++) els.calendarBody.appendChild(document.createElement('div'));

            const myRecords = {};
            allRecords.filter(r => r.userName === currentUser).forEach(r => myRecords[r.date] = r);

            for (let d = 1; d <= last; d++) {
                const date = new Date(y, m, d);
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isT = date.getDay() === 0 || date.getDay() === 3;
                
                const cell = document.createElement('div');
                cell.className = `calendar-day active-day ${isT ? 'training-day' : ''}`;
                
                const rec = myRecords[ds] || {};
                const dist = parseFloat(rec.distance) || 0;
                
                cell.innerHTML = `
                    <div class="${date.getDay() === 0 ? 'text-red-500' : ''}">${d}</div>
                    <div class="text-[9px] font-black mt-1 text-blue-600">${dist > 0 ? dist : ''}</div>
                    ${rec.attendance ? '<div class="absolute bottom-1 w-1 h-1 rounded-full bg-emerald-500"></div>' : ''}
                `;
                
                cell.onclick = () => {
                    selectedDateStr = ds;
                    els.modalDate.textContent = ds;
                    els.inputDistance.value = rec.distance || '';
                    els.inputAttendance.checked = rec.attendance || false;
                    document.getElementById('attendance-area').style.display = isT ? 'flex' : 'none';
                    els.modal.classList.remove('hidden');
                };
                els.calendarBody.appendChild(cell);
            }
        }

        // ì´ë²¤íŠ¸
        document.getElementById('btn-login').onclick = () => {
            const n = els.userSelect.value;
            if (n) {
                localStorage.setItem('srt_user_name', n);
                currentUser = n;
                showMain();
            }
        };

        document.getElementById('btn-logout').onclick = () => {
            localStorage.removeItem('srt_user_name');
            location.reload();
        };

        document.getElementById('btn-prev-month').onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            els.calendarTitle.textContent = `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth() + 1}ì›”`;
            renderCalendar(); renderRanking(); updateStats();
        };

        document.getElementById('btn-next-month').onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            els.calendarTitle.textContent = `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth() + 1}ì›”`;
            renderCalendar(); renderRanking(); updateStats();
        };

        document.getElementById('btn-close-modal').onclick = () => els.modal.classList.add('hidden');

        els.btnSave.onclick = async () => {
            const dist = parseFloat(els.inputDistance.value) || 0;
            const attr = els.inputAttendance.checked;
            const payload = {
                distance: dist,
                attendance: !!attr,
                userName: currentUser,
                date: selectedDateStr,
                ts: Date.now()
            };

            try {
                els.btnSave.disabled = true;
                els.btnSave.textContent = "ì €ì¥ ì¤‘...";
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', `${currentUser}_${selectedDateStr}`), payload);
                els.modal.classList.add('hidden');
            } catch (err) {
                console.error(err);
                alert("ì €ì¥ ì‹¤íŒ¨! Firebase Rulesì—ì„œ ì“°ê¸° ê¶Œí•œì„ í™•ì¸í•˜ì„¸ìš”.");
            } finally {
                els.btnSave.disabled = false;
                els.btnSave.textContent = "ê¸°ë¡ ì €ì¥í•˜ê¸°";
            }
        };

        init();
    </script>
</body>
</html>