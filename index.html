<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRT Dì¡° ì¶œì„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.75rem; transition: background 0.2s; }
        .active-day { background-color: #f0f7ff; border: 1px solid #e0eaff; cursor: pointer; }
        .active-day:active { background-color: #dbeafe; }
        .dimmed-day { color: #cbd5e0; }
        .training-day { font-weight: bold; color: #1e40af; border: 2px solid #3b82f6; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-900">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-xl overflow-x-hidden relative">
        <!-- Loading Spinner -->
        <div id="loading" class="fixed inset-0 bg-white z-[60] flex items-center justify-center">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
                <p class="mt-4 text-gray-500 font-medium">SRT Dì¡° ë°ì´í„° ë¡œë”© ì¤‘...</p>
            </div>
        </div>

        <!-- Error Message Overlay -->
        <div id="error-overlay" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-6 text-center">
            <div class="bg-white p-8 rounded-3xl max-w-sm">
                <div class="text-red-500 text-5xl mb-4">âš ï¸</div>
                <h3 class="text-xl font-bold mb-2">ì¸ì¦ ì„¤ì • ì˜¤ë¥˜</h3>
                <p id="error-text" class="text-gray-600 text-sm mb-6 leading-relaxed">Firebase ì½˜ì†”ì—ì„œ 'Anonymous' ì¸ì¦ì„ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.</p>
                <button onclick="location.reload()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="screen-login" class="hidden p-6 flex flex-col items-center justify-center min-h-screen">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-black text-blue-700">SRT Dì¡°</h1>
                <p class="text-gray-500 font-medium mt-2">2026 í›ˆë ¨ ë°ì´í„° ì‹œìŠ¤í…œ</p>
            </div>
            
            <div class="w-full space-y-4">
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <label class="block text-sm font-bold mb-2 text-gray-600">ì´ë¦„ ì„ íƒ</label>
                    <select id="user-select" class="w-full p-3 bg-white border border-gray-200 rounded-xl text-lg outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                <button id="btn-login" class="w-full bg-blue-600 text-white py-4 rounded-2xl text-xl font-bold shadow-lg active:bg-blue-700 transition-colors">
                    ë°ì´í„° í™•ì¸í•˜ê¸°
                </button>
            </div>

            <!-- Dashboard Rankings -->
            <div class="w-full mt-12 bg-gray-50 p-5 rounded-3xl border border-gray-100">
                <h2 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                    <span class="mr-2 text-xl">ğŸ†</span> ì›”ê°„ ì‹¤ì‹œê°„ ë­í‚¹ (TOP 8)
                </h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-3">
                        <h3 class="text-xs font-black text-blue-600 uppercase tracking-wider">ğŸƒ ê±°ë¦¬ ëˆ„ê³„</h3>
                        <ul id="rank-distance" class="text-[11px] space-y-2"></ul>
                    </div>
                    <div class="space-y-3">
                        <h3 class="text-xs font-black text-green-600 uppercase tracking-wider">âœ… ì¶œì„ íšŸìˆ˜</h3>
                        <ul id="rank-attendance" class="text-[11px] space-y-2"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Screen -->
        <div id="screen-main" class="hidden">
            <header class="bg-gradient-to-br from-blue-600 to-blue-800 text-white p-6 rounded-b-[2.5rem] shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <span id="display-name" class="text-2xl font-black"></span>
                        <span class="text-sm opacity-90 ml-1">ëŸ¬ë„ˆë‹˜</span>
                    </div>
                    <button id="btn-logout" class="text-[10px] bg-white/20 px-3 py-1.5 rounded-full font-bold hover:bg-white/30 transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-white/10 p-4 rounded-2xl border border-white/10">
                        <p class="text-[10px] uppercase font-bold opacity-70 mb-1">ì›”ê°„ ê±°ë¦¬</p>
                        <p class="text-xl font-black"><span id="stats-dist">0.0</span> <small class="text-sm">km</small></p>
                    </div>
                    <div class="bg-white/10 p-4 rounded-2xl border border-white/10">
                        <p class="text-[10px] uppercase font-bold opacity-70 mb-1">ì›”ê°„ ì¶œì„</p>
                        <p class="text-xl font-black"><span id="stats-attr">0</span> <small class="text-sm">íšŒ</small></p>
                    </div>
                </div>
            </header>

            <main class="p-5">
                <div class="flex items-center justify-between mb-6">
                    <button id="btn-prev-month" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-lg font-bold shadow-sm active:scale-90">ã€ˆ</button>
                    <h2 id="calendar-title" class="text-xl font-black text-gray-800">2026ë…„ 1ì›”</h2>
                    <button id="btn-next-month" class="w-10 h-10 flex items-center justify-center bg-gray-100 rounded-full text-lg font-bold shadow-sm active:scale-90">ã€‰</button>
                </div>

                <div class="calendar-grid mb-3">
                    <div class="text-center text-[10px] font-black text-red-500 opacity-60">ì¼</div>
                    <div class="text-center text-[10px] font-black text-gray-400">ì›”</div>
                    <div class="text-center text-[10px] font-black text-gray-400">í™”</div>
                    <div class="text-center text-[10px] font-black text-blue-500 opacity-60">ìˆ˜</div>
                    <div class="text-center text-[10px] font-black text-gray-400">ëª©</div>
                    <div class="text-center text-[10px] font-black text-gray-400">ê¸ˆ</div>
                    <div class="text-center text-[10px] font-black text-gray-400">í† </div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>

                <div class="mt-8 p-5 bg-blue-50 rounded-3xl border border-blue-100">
                    <h4 class="text-xs font-bold text-blue-800 mb-2">í›ˆë ¨ ì•ˆë‚´</h4>
                    <ul class="text-[11px] text-blue-600 space-y-1 opacity-80">
                        <li>â€¢ ë§¤ì£¼ ìˆ˜ìš”ì¼, ì¼ìš”ì¼ì€ ê³µì‹ í›ˆë ¨ì¼ì…ë‹ˆë‹¤.</li>
                        <li>â€¢ ë‚ ì§œë¥¼ í„°ì¹˜í•˜ì—¬ ê±°ë¦¬ì™€ ì¶œì„ì„ ì…ë ¥í•˜ì„¸ìš”.</li>
                        <li>â€¢ í›ˆë ¨ ê²°ê³¼ëŠ” ì‹¤ì‹œê°„ ë­í‚¹ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</li>
                    </ul>
                </div>
            </main>
        </div>

        <!-- Input Modal -->
        <div id="modal" class="hidden fixed inset-0 bg-black/60 z-[70] flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white w-full max-w-sm rounded-t-[2.5rem] sm:rounded-[2.5rem] p-8 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-xs font-bold text-blue-600 uppercase mb-1">RECORD ENTRY</p>
                        <h3 id="modal-date" class="text-2xl font-black text-gray-800">2026-01-01</h3>
                    </div>
                    <button id="btn-close-modal" class="text-gray-400 hover:text-gray-600 p-2">âœ•</button>
                </div>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold mb-2 text-gray-600 ml-1">ë‹¬ë¦° ê±°ë¦¬ (km)</label>
                        <input type="number" id="input-distance" step="0.1" class="w-full p-4 bg-gray-50 border-2 border-gray-100 rounded-2xl text-2xl font-bold outline-none focus:border-blue-500 transition-colors" placeholder="0.0">
                    </div>
                    <div id="attendance-toggle-area" class="flex items-center justify-between p-5 bg-blue-50 rounded-2xl border border-blue-100">
                        <div class="flex items-center">
                            <span class="text-blue-800 font-bold">ê³µì‹ ëª¨ì„ ì¶œì„</span>
                        </div>
                        <input type="checkbox" id="input-attendance" class="w-7 h-7 rounded-lg border-blue-300 text-blue-600 focus:ring-blue-500">
                    </div>
                    <div class="flex space-x-3 pt-2">
                        <button id="btn-save" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-lg active:scale-95 transition-transform">ë°ì´í„° ì €ì¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Using Environment Variables if available, else provided fallback)
        const userProvidedConfig = {
            apiKey: "AIzaSyBBP8vP90bOisbNlDpsp64k3hxLZw7x2JE",
            authDomain: "attendnew-63c66.firebaseapp.com",
            databaseURL: "https://attendnew-63c66-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "attendnew-63c66",
            storageBucket: "attendnew-63c66.firebasestorage.app",
            messagingSenderId: "992717620682",
            appId: "1:992717620682:web:5ee93256b2a5172d72fb33"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : userProvidedConfig;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-group';

        const members = [
            "ê°•ë™í˜„", "ê°•ë™í›ˆ", "ì†¡ì±„í•œ", "ê¹€ë¯¸í™”", "ê¹€ì¬ì‚°", "ê¹€ì°¬ì„", "ê¹€í•œë‚˜", "ë¥˜ì§€ì°¬", 
            "ë°•ì„±í™˜", "ë°•ì¢…ë´‰", "ì†Œë³‘ë“", "ì„œì •í™”", "ì‹ ì˜ì„­", "ì•ˆì§€í›ˆ", "ì˜¤í•œì²œ", "ì´ìŠ¹ì¤€", 
            "ì´ìš©êµ¬", "ì •ë•ìˆ˜", "ì£¼íš¨ì„", "ì„œì¸ìˆ˜", "ë°•ì°½ì„ ", "ê¹€ë³‘ì‹"
        ].sort();

        // State Management
        let currentUser = null;
        let authUser = null;
        let currentMonth = new Date(2026, 0, 1);
        let selectedDateStr = "";
        let userData = {}; 
        let allRecords = []; 
        let unsubPrivate = null;
        let unsubPublic = null;

        // UI Elements
        const elements = {
            loading: document.getElementById('loading'),
            loginScreen: document.getElementById('screen-login'),
            mainScreen: document.getElementById('screen-main'),
            userSelect: document.getElementById('user-select'),
            modal: document.getElementById('modal'),
            modalDate: document.getElementById('modal-date'),
            inputDistance: document.getElementById('input-distance'),
            inputAttendance: document.getElementById('input-attendance'),
            btnSave: document.getElementById('btn-save'),
            statsDist: document.getElementById('stats-dist'),
            statsAttr: document.getElementById('stats-attr'),
            calendarTitle: document.getElementById('calendar-title'),
            calendarBody: document.getElementById('calendar-body'),
            displayName: document.getElementById('display-name'),
            rankDist: document.getElementById('rank-distance'),
            rankAttr: document.getElementById('rank-attendance'),
            errorOverlay: document.getElementById('error-overlay'),
            errorText: document.getElementById('error-text')
        };

        // UI Update Functions
        function updateStats() {
            const y = currentMonth.getFullYear();
            const m = currentMonth.getMonth();
            let dSum = 0, aSum = 0;

            Object.keys(userData).forEach(ds => {
                const date = new Date(ds);
                if (date.getFullYear() === y && date.getMonth() === m) {
                    dSum += parseFloat(userData[ds].distance || 0);
                    if (userData[ds].attendance) aSum++;
                }
            });
            elements.statsDist.textContent = dSum.toFixed(1);
            elements.statsAttr.textContent = aSum;
        }

        function updateRankings() {
            const y = 2026;
            const m = currentMonth.getMonth();
            const scores = {};
            members.forEach(n => scores[n] = { dist: 0, attr: 0 });

            allRecords.forEach(r => {
                const parts = r.id.split('_');
                const name = parts[0];
                const ds = parts[1];
                if (!ds || !scores[name]) return;
                const dt = new Date(ds);
                if (dt.getFullYear() === y && dt.getMonth() === m) {
                    scores[name].dist += parseFloat(r.distance || 0);
                    if (r.attendance) scores[name].attr += 1;
                }
            });

            const sortedD = Object.entries(scores).sort((a,b) => b[1].dist - a[1].dist).slice(0, 8);
            const sortedA = Object.entries(scores).sort((a,b) => b[1].attr - a[1].attr).slice(0, 8);

            elements.rankDist.innerHTML = sortedD.map(([n, s], i) => `
                <li class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0">
                    <span class="text-gray-400 font-bold w-4">${i+1}</span>
                    <span class="flex-1 font-bold text-gray-700 ml-1">${n}</span>
                    <span class="text-blue-600 font-black">${s.dist.toFixed(1)}</span>
                </li>
            `).join('') || "No Data";

            elements.rankAttr.innerHTML = sortedA.map(([n, s], i) => `
                <li class="flex justify-between items-center py-1 border-b border-gray-100 last:border-0">
                    <span class="text-gray-400 font-bold w-4">${i+1}</span>
                    <span class="flex-1 font-bold text-gray-700 ml-1">${n}</span>
                    <span class="text-green-600 font-black">${s.attr}</span>
                </li>
            `).join('') || "No Data";
        }

        function renderCalendar() {
            elements.calendarBody.innerHTML = '';
            const y = currentMonth.getFullYear();
            const m = currentMonth.getMonth();
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < first; i++) {
                const empty = document.createElement('div');
                empty.className = 'calendar-day';
                elements.calendarBody.appendChild(empty);
            }

            for (let d = 1; d <= last; d++) {
                const date = new Date(y, m, d);
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isT = date.getDay() === 0 || date.getDay() === 3;
                const cell = document.createElement('div');
                cell.className = `calendar-day active-day ${isT ? 'training-day' : ''}`;
                
                const rec = userData[ds] || {};
                const dotColor = rec.attendance ? 'bg-green-500' : (rec.distance > 0 ? 'bg-blue-400' : 'bg-transparent');
                
                cell.innerHTML = `
                    <div class="${date.getDay() === 0 ? 'text-red-500' : (date.getDay() === 3 ? 'text-blue-600 font-black' : '')}">${d}</div>
                    <div class="text-[9px] font-bold mt-1 text-gray-500">${rec.distance > 0 ? rec.distance : ''}</div>
                    <div class="w-1.5 h-1.5 rounded-full mt-0.5 ${dotColor}"></div>
                `;
                cell.onclick = () => openModal(ds, isT);
                elements.calendarBody.appendChild(cell);
            }
        }

        // Action Handlers
        const openModal = (ds, isT) => {
            selectedDateStr = ds;
            elements.modalDate.textContent = ds;
            const rec = userData[ds] || {};
            elements.inputDistance.value = rec.distance || '';
            elements.inputAttendance.checked = rec.attendance || false;
            document.getElementById('attendance-toggle-area').style.display = isT ? 'flex' : 'none';
            elements.modal.classList.remove('hidden');
        };

        const closeModal = () => elements.modal.classList.add('hidden');

        const saveRecord = async () => {
            if (!authUser || !currentUser) return;
            const dist = elements.inputDistance.value;
            const attr = elements.inputAttendance.checked;
            const payload = {
                distance: dist ? parseFloat(dist) : 0,
                attendance: !!attr,
                userName: currentUser,
                date: selectedDateStr,
                updatedAt: new Date().toISOString()
            };

            try {
                elements.btnSave.disabled = true;
                elements.btnSave.textContent = "ì €ì¥ ì¤‘...";
                
                // Rule 1 & Rule 3: Write after Auth
                await setDoc(doc(db, 'artifacts', appId, 'users', authUser.uid, 'records', selectedDateStr), payload);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'records', `${currentUser}_${selectedDateStr}`), payload);
                
                closeModal();
            } catch (err) {
                console.error("Save Error:", err);
            } finally {
                elements.btnSave.disabled = false;
                elements.btnSave.textContent = "ë°ì´í„° ì €ì¥";
            }
        };

        // Firebase Sync Listeners
        function startPublicListener() {
            if (!authUser) return;
            const publicRef = collection(db, 'artifacts', appId, 'public', 'data', 'records');
            if (unsubPublic) unsubPublic();
            unsubPublic = onSnapshot(publicRef, (snapshot) => {
                allRecords = [];
                snapshot.forEach(doc => allRecords.push({ ...doc.data(), id: doc.id }));
                updateRankings();
            }, (err) => console.error("Public Sync Error:", err));
        }

        function enterApp(name) {
            if (!authUser) return;
            currentUser = name;
            elements.displayName.textContent = name;
            elements.loginScreen.classList.add('hidden');
            elements.mainScreen.classList.remove('hidden');
            
            const privateRef = collection(db, 'artifacts', appId, 'users', authUser.uid, 'records');
            if (unsubPrivate) unsubPrivate();
            unsubPrivate = onSnapshot(privateRef, (snapshot) => {
                userData = {};
                snapshot.forEach(doc => userData[doc.id] = doc.data());
                renderCalendar();
                updateStats();
            }, (err) => console.error("Private Sync Error:", err));
        }

        // Initialize App Logic
        async function initApp() {
            // Fill Member Select
            members.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.textContent = m;
                elements.userSelect.appendChild(opt);
            });

            // Authentication Handler (Rule 3)
            const handleAuth = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        // Attempt Anonymous Sign-in (Required for this setup)
                        await signInAnonymously(auth);
                    }
                } catch (err) {
                    console.error("Auth Failure:", err);
                    if (err.code === 'auth/configuration-not-found') {
                        elements.errorText.innerHTML = "Firebase ì½˜ì†”ì—ì„œ <b>ìµëª… ë¡œê·¸ì¸(Anonymous)</b> ê¸°ëŠ¥ì„ í™œì„±í™”í•´ì•¼ í•©ë‹ˆë‹¤.<br><br><small class='text-gray-400'>Authentication -> Sign-in method -> ìµëª… ë¡œê·¸ì¸ í™œì„±í™”</small>";
                        elements.errorOverlay.classList.remove('hidden');
                        elements.loading.classList.add('hidden');
                    }
                }
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    authUser = user;
                    elements.loading.classList.add('hidden');
                    startPublicListener();

                    const savedName = localStorage.getItem('srt_d_user_name');
                    if (savedName && members.includes(savedName)) {
                        enterApp(savedName);
                    } else {
                        elements.loginScreen.classList.remove('hidden');
                    }
                }
            });

            await handleAuth();
        }

        // Event Listeners
        document.getElementById('btn-login').onclick = () => {
            const name = elements.userSelect.value;
            if (name) {
                localStorage.setItem('srt_d_user_name', name);
                enterApp(name);
            }
        };
        document.getElementById('btn-logout').onclick = () => {
            if (unsubPrivate) unsubPrivate();
            localStorage.removeItem('srt_d_user_name');
            currentUser = null;
            elements.mainScreen.classList.add('hidden');
            elements.loginScreen.classList.remove('hidden');
        };
        document.getElementById('btn-prev-month').onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            elements.calendarTitle.textContent = `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth() + 1}ì›”`;
            renderCalendar(); updateStats(); updateRankings();
        };
        document.getElementById('btn-next-month').onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            elements.calendarTitle.textContent = `${currentMonth.getFullYear()}ë…„ ${currentMonth.getMonth() + 1}ì›”`;
            renderCalendar(); updateStats(); updateRankings();
        };
        document.getElementById('btn-close-modal').onclick = closeModal;
        elements.btnSave.onclick = saveRecord;

        // Run entry point
        initApp();
    </script>
</body>
</html>
