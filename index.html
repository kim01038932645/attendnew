<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRT DÏ°∞ Ï∂úÏÑùÎ∂Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .calendar-day { min-height: 60px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 0.75rem; transition: all 0.2s; position: relative; border: 1px solid transparent; }
        .active-day { background-color: #f8fafc; border-color: #f1f5f9; cursor: pointer; }
        .active-day:active { background-color: #f1f5f9; transform: scale(0.95); }
        .training-day { font-weight: 800; color: #1d4ed8; background-color: #eff6ff; border-color: #bfdbfe; }
        .training-day::after { content: '‚Ä¢'; position: absolute; top: 2px; right: 4px; color: #3b82f6; font-size: 14px; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-2xl relative flex flex-col">
        
        <!-- Î°úÎî© ÌôîÎ©¥ -->
        <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex items-center justify-center transition-opacity duration-500">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
                <p class="mt-4 text-slate-500 font-bold text-sm tracking-tight">Îç∞Ïù¥ÌÑ∞ Ïó∞Í≤∞ Ï§ë...</p>
            </div>
        </div>

        <!-- [ÌôîÎ©¥ 1] Î°úÍ∑∏Ïù∏ + Îû≠ÌÇπ ÌôîÎ©¥ -->
        <div id="screen-login" class="hidden flex-1 flex flex-col p-6 overflow-y-auto">
            <div class="text-center py-10">
                <div class="inline-block p-4 bg-blue-50 rounded-full mb-4 text-3xl">üèÉ‚Äç‚ôÇÔ∏è</div>
                <h1 class="text-3xl font-black text-slate-900 tracking-tighter">SRT DÏ°∞</h1>
                <p class="text-slate-400 font-bold mt-1 text-xs tracking-widest uppercase">2026 Season</p>
            </div>
            
            <!-- Ï†ëÏÜç ÏòÅÏó≠ -->
            <div class="w-full space-y-4 mb-10">
                <div class="bg-slate-50 p-5 rounded-3xl border border-slate-100">
                    <label class="block text-[10px] font-black mb-2 text-slate-400 uppercase ml-1">Member Login</label>
                    <select id="user-select" class="w-full p-4 bg-white border border-slate-200 rounded-2xl text-lg font-bold outline-none focus:ring-4 focus:ring-blue-100 transition-all appearance-none">
                        <option value="">Î≥∏Ïù∏ Ïù¥Î¶ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</option>
                    </select>
                </div>
                <button id="btn-login" class="w-full bg-blue-600 text-white py-5 rounded-3xl text-xl font-black shadow-lg shadow-blue-200 active:scale-95 transition-all">
                    ÎÇ¥ Ï∂úÏÑùÎ∂Ä Îì§Ïñ¥Í∞ÄÍ∏∞
                </button>
            </div>

            <!-- Ï≤´ÌôîÎ©¥ Îû≠ÌÇπ ÏÑπÏÖò -->
            <div class="flex-1 flex flex-col">
                <div class="flex items-center justify-between mb-2 px-2">
                    <h3 class="text-xs font-black text-slate-800 uppercase tracking-widest">Crew Ranking</h3>
                    <span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-tighter">Real-time</span>
                </div>

                <!-- Îû≠ÌÇπ ÌÉ≠ -->
                <div class="flex border-b border-slate-100 mb-4 px-2">
                    <button id="tab-dist" class="flex-1 py-3 text-xs font-black text-slate-400 tab-active transition-all">ÎàÑÏ†Å Í±∞Î¶¨Ïàú</button>
                    <button id="tab-attr" class="flex-1 py-3 text-xs font-black text-slate-400 transition-all">Ï∂úÏÑù ÌöüÏàòÏàú</button>
                </div>

                <div class="grid grid-cols-1 gap-3 mb-8" id="rank-list-login">
                    <!-- Îû≠ÌÇπ Î¶¨Ïä§Ìä∏ -->
                </div>
            </div>
        </div>

        <!-- [ÌôîÎ©¥ 2] ÎÇ¥ Ï∂úÏÑùÎ∂Ä ÌôîÎ©¥ -->
        <div id="screen-main" class="hidden flex-1 flex flex-col overflow-y-auto">
            <header class="bg-slate-900 text-white p-8 rounded-b-[2.5rem] shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <p class="text-[10px] font-bold text-blue-400 uppercase mb-1">Crew Member</p>
                        <span id="display-name" class="text-2xl font-black"></span><span class="opacity-60 font-medium ml-1 text-sm">Îü¨ÎÑà</span>
                    </div>
                    <button id="btn-logout" class="bg-white/10 px-4 py-2.5 rounded-xl text-xs font-bold border border-white/10 active:bg-white/20">ÌôàÏúºÎ°ú</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                        <p class="text-[9px] font-black text-blue-400 mb-1 uppercase tracking-wider">Distance</p>
                        <p class="text-xl font-black"><span id="stats-dist">0.0</span> <small class="text-[10px] opacity-40 uppercase">km</small></p>
                    </div>
                    <div class="bg-white/5 p-4 rounded-2xl border border-white/10">
                        <p class="text-[9px] font-black text-emerald-400 mb-1 uppercase tracking-wider">Attendance</p>
                        <p class="text-xl font-black"><span id="stats-attr">0</span> <small class="text-[10px] opacity-40 uppercase">Ìöå</small></p>
                    </div>
                </div>
            </header>

            <main class="p-5 flex-1">
                <div class="flex items-center justify-between mb-6">
                    <button id="btn-prev-month" class="p-3 text-slate-400 font-bold active:bg-slate-100 rounded-full">„Äà</button>
                    <h2 id="calendar-title" class="text-xl font-black text-slate-800">2026ÎÖÑ 1Ïõî</h2>
                    <button id="btn-next-month" class="p-3 text-slate-400 font-bold active:bg-slate-100 rounded-full">„Äâ</button>
                </div>

                <div class="calendar-grid mb-3 px-1 text-center">
                    <div class="text-[10px] font-black text-red-400 uppercase">Sun</div>
                    <div class="text-[10px] font-black text-slate-300 uppercase">Mon</div>
                    <div class="text-[10px] font-black text-slate-300 uppercase">Tue</div>
                    <div class="text-[10px] font-black text-blue-400 uppercase">Wed</div>
                    <div class="text-[10px] font-black text-slate-300 uppercase">Thu</div>
                    <div class="text-[10px] font-black text-slate-300 uppercase">Fri</div>
                    <div class="text-[10px] font-black text-slate-300 uppercase">Sat</div>
                </div>
                <div id="calendar-body" class="calendar-grid"></div>
                <p class="mt-6 text-[10px] text-slate-300 text-center font-bold uppercase tracking-widest">Tap date to record your run</p>
            </main>
        </div>

        <!-- ÏûÖÎ†• Î™®Îã¨ -->
        <div id="modal" class="hidden fixed inset-0 bg-slate-900/60 z-[110] flex items-end justify-center backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-sm rounded-[2.5rem] p-8 animate-slide-up shadow-2xl">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <p class="text-[10px] font-black text-blue-600 mb-1 uppercase tracking-widest">Input Activity</p>
                        <h3 id="modal-date" class="text-xl font-black text-slate-800">2026-01-01</h3>
                    </div>
                    <button id="btn-close-modal" class="w-8 h-8 flex items-center justify-center bg-slate-100 rounded-full text-slate-400 text-sm">‚úï</button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-[10px] font-black mb-2 text-slate-400 uppercase">Run Distance (KM)</label>
                        <input type="number" id="input-distance" step="0.1" class="w-full p-4 bg-slate-50 border-2 border-transparent rounded-2xl text-2xl font-black outline-none focus:border-blue-500 focus:bg-white transition-all" placeholder="0.0">
                    </div>
                    <div id="attendance-area" class="flex items-center justify-between p-4 bg-blue-50/50 rounded-2xl border border-blue-100">
                        <span class="text-blue-900 font-bold text-sm">Ï†ïÍ∏∞ ÌõàÎ†® Ï∂úÏÑù Ï≤¥ÌÅ¨</span>
                        <input type="checkbox" id="input-attendance" class="w-6 h-6 rounded-lg accent-blue-600 cursor-pointer">
                    </div>
                    <button id="btn-save" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-black text-lg shadow-xl shadow-blue-100 active:scale-95 transition-all">Í∏∞Î°ù Ï†ÄÏû•ÌïòÍ∏∞</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyBBP8vP90bOisbNlDpsp64k3hxLZw7x2JE",
            authDomain: "attendnew-63c66.firebaseapp.com",
            projectId: "attendnew-63c66",
            storageBucket: "attendnew-63c66.firebasestorage.app",
            messagingSenderId: "992717620682",
            appId: "1:992717620682:web:5ee93256b2a5172d72fb33"
        };

        const appId = "srt-d-crew-2026";
        const members = [
            "Í∞ïÎèôÌòÑ", "Í∞ïÎèôÌõà", "ÏÜ°Ï±ÑÌïú", "ÍπÄÎØ∏Ìôî", "ÍπÄÏû¨ÏÇ∞", "ÍπÄÏ∞¨ÏÑù", "ÍπÄÌïúÎÇò", "Î•òÏßÄÏ∞¨", 
            "Î∞ïÏÑ±Ìôò", "Î∞ïÏ¢ÖÎ¥â", "ÏÜåÎ≥ëÎìù", "ÏÑúÏ†ïÌôî", "Ïã†ÏòÅÏÑ≠", "ÏïàÏßÄÌõà", "Ïò§ÌïúÏ≤ú", "Ïù¥ÏäπÏ§Ä", 
            "Ïù¥Ïö©Íµ¨", "Ï†ïÎçïÏàò", "Ï£ºÌö®ÏÑù", "ÏÑúÏù∏Ïàò", "Î∞ïÏ∞ΩÏÑ†", "ÍπÄÎ≥ëÏãù"
        ].sort();

        let db;
        let currentUser = localStorage.getItem('srt_user_name') || null;
        let currentMonth = new Date(2026, 0, 1);
        let selectedDateStr = "";
        let allRecords = [];
        let currentRankType = 'distance'; // 'distance' | 'attendance'

        const els = {
            loading: document.getElementById('loading-overlay'),
            loginScreen: document.getElementById('screen-login'),
            mainScreen: document.getElementById('screen-main'),
            userSelect: document.getElementById('user-select'),
            calendarTitle: document.getElementById('calendar-title'),
            calendarBody: document.getElementById('calendar-body'),
            rankListLogin: document.getElementById('rank-list-login'),
            modal: document.getElementById('modal'),
            modalDate: document.getElementById('modal-date'),
            inputDistance: document.getElementById('input-distance'),
            inputAttendance: document.getElementById('input-attendance'),
            btnSave: document.getElementById('btn-save'),
            statsDist: document.getElementById('stats-dist'),
            statsAttr: document.getElementById('stats-attr'),
            tabDist: document.getElementById('tab-dist'),
            tabAttr: document.getElementById('tab-attr')
        };

        function init() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
            } catch (e) {
                console.error("Firebase Init Error", e);
            }

            members.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m; opt.textContent = m;
                els.userSelect.appendChild(opt);
            });

            if (currentUser && members.includes(currentUser)) {
                showMain();
            } else {
                showLogin();
            }

            setTimeout(() => {
                els.loading.style.opacity = '0';
                setTimeout(() => els.loading.classList.add('hidden'), 500);
            }, 800);

            startSync();
        }

        function showLogin() {
            els.loginScreen.classList.remove('hidden');
            els.mainScreen.classList.add('hidden');
            renderRanking();
        }

        function showMain() {
            document.getElementById('display-name').textContent = currentUser;
            els.loginScreen.classList.add('hidden');
            els.mainScreen.classList.remove('hidden');
            renderCalendar();
            updateStats();
        }

        function startSync() {
            if (!db) return;
            const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'records');
            onSnapshot(colRef, (snap) => {
                allRecords = snap.docs.map(d => ({ ...d.data(), id: d.id }));
                renderCalendar();
                renderRanking();
                updateStats();
            }, (err) => console.error("Firestore Error:", err));
        }

        function renderRanking() {
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            const scores = {};
            members.forEach(name => scores[name] = { dist: 0, attr: 0 });

            allRecords.forEach(r => {
                const name = r.userName;
                const ds = r.date;
                if (!name || !ds || !scores[name]) return;
                const d = new Date(ds);
                if (d.getFullYear() === y && d.getMonth() === m) {
                    scores[name].dist += parseFloat(r.distance || 0);
                    if (r.attendance) scores[name].attr++;
                }
            });

            let sorted = Object.entries(scores).filter(([_, s]) => s.dist > 0 || s.attr > 0);

            if (currentRankType === 'distance') {
                sorted.sort((a, b) => b[1].dist - a[1].dist || b[1].attr - a[1].attr);
            } else {
                sorted.sort((a, b) => b[1].attr - a[1].attr || b[1].dist - a[1].dist);
            }

            sorted = sorted.slice(0, 15);

            const container = els.rankListLogin;
            if (sorted.length === 0) {
                container.innerHTML = '<div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl p-10 text-center"><p class="text-slate-400 text-xs font-bold uppercase tracking-tighter">No data available for this month</p></div>';
                return;
            }

            container.innerHTML = sorted.map(([name, s], i) => `
                <div class="flex items-center justify-between bg-white p-4 rounded-2xl border border-slate-100 shadow-sm ${name === currentUser ? 'ring-2 ring-blue-600 ring-offset-2' : ''}">
                    <div class="flex items-center">
                        <div class="w-6 flex flex-col items-center">
                            <span class="text-[10px] font-black ${i < 3 ? 'text-blue-600' : 'text-slate-300'}">${i+1}</span>
                            ${i < 3 ? '<span class="text-[8px]">üèÜ</span>' : ''}
                        </div>
                        <div class="ml-3">
                            <p class="font-bold text-slate-800 leading-none mb-1">${name}</p>
                            <p class="text-[8px] font-black text-slate-300 uppercase">${i < 3 ? 'Top Runner' : 'Crew'}</p>
                        </div>
                    </div>
                    <div class="flex gap-4 items-center">
                        <div class="text-right ${currentRankType === 'distance' ? 'opacity-100 scale-105 transition-all' : 'opacity-40'}">
                            <p class="text-[8px] font-black text-slate-400 uppercase mb-0.5">Dist</p>
                            <p class="text-sm font-black text-blue-600 leading-none">${s.dist.toFixed(1)}<small class="text-[9px] font-medium ml-0.5">km</small></p>
                        </div>
                        <div class="text-right border-l border-slate-100 pl-4 ${currentRankType === 'attendance' ? 'opacity-100 scale-105 transition-all' : 'opacity-40'}">
                            <p class="text-[8px] font-black text-slate-400 uppercase mb-0.5">Attr</p>
                            <p class="text-sm font-black text-emerald-600 leading-none">${s.attr}<small class="text-[9px] font-medium ml-0.5">Ìöå</small></p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateStats() {
            if (!currentUser) return;
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            let dSum = 0, aSum = 0;
            allRecords.forEach(r => {
                if (r.userName === currentUser) {
                    const d = new Date(r.date);
                    if (d.getFullYear() === y && d.getMonth() === m) {
                        dSum += parseFloat(r.distance || 0);
                        if (r.attendance) aSum++;
                    }
                }
            });
            els.statsDist.textContent = dSum.toFixed(1);
            els.statsAttr.textContent = aSum;
        }

        function renderCalendar() {
            els.calendarBody.innerHTML = '';
            const y = currentMonth.getFullYear(), m = currentMonth.getMonth();
            const first = new Date(y, m, 1).getDay();
            const last = new Date(y, m + 1, 0).getDate();

            for (let i = 0; i < first; i++) els.calendarBody.appendChild(document.createElement('div'));

            const myRecords = {};
            allRecords.filter(r => r.userName === currentUser).forEach(r => myRecords[r.date] = r);

            for (let d = 1; d <= last; d++) {
                const date = new Date(y, m, d);
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                const isT = date.getDay() === 0 || date.getDay() === 3;
                
                const cell = document.createElement('div');
                cell.className = `calendar-day active-day ${isT ? 'training-day shadow-sm' : ''}`;
                
                const rec = myRecords[ds] || {};
                const dist = parseFloat(rec.distance) || 0;
                
                cell.innerHTML = `
                    <div class="${date.getDay() === 0 ? 'text-red-500' : ''}">${d}</div>
                    <div class="text-[9px] font-black mt-1 text-blue-600 h-3">${dist > 0 ? dist : ''}</div>
                    ${rec.attendance ? '<div class="absolute bottom-1.5 w-1.5 h-1.5 rounded-full bg-emerald-500 shadow-sm border border-white"></div>' : ''}
                `;
                
                cell.onclick = () => {
                    selectedDateStr = ds;
                    els.modalDate.textContent = ds;
                    els.inputDistance.value = rec.distance || '';
                    els.inputAttendance.checked = rec.attendance || false;
                    document.getElementById('attendance-area').style.display = isT ? 'flex' : 'none';
                    els.modal.classList.remove('hidden');
                };
                els.calendarBody.appendChild(cell);
            }
        }

        // --- Ïù¥Î≤§Ìä∏ ---
        els.tabDist.onclick = () => {
            currentRankType = 'distance';
            els.tabDist.classList.add('tab-active');
            els.tabAttr.classList.remove('tab-active');
            renderRanking();
        };

        els.tabAttr.onclick = () => {
            currentRankType = 'attendance';
            els.tabAttr.classList.add('tab-active');
            els.tabDist.classList.remove('tab-active');
            renderRanking();
        };

        document.getElementById('btn-login').onclick = () => {
            const n = els.userSelect.value;
            if (n) {
                localStorage.setItem('srt_user_name', n);
                currentUser = n;
                showMain();
            }
        };

        document.getElementById('btn-logout').onclick = () => {
            els.loginScreen.classList.remove('hidden');
            els.mainScreen.classList.add('hidden');
            renderRanking();
        };

        document.getElementById('btn-prev-month').onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            els.calendarTitle.textContent = `${currentMonth.getFullYear()}ÎÖÑ ${currentMonth.getMonth() + 1}Ïõî`;
            renderCalendar(); renderRanking(); updateStats();
        };

        document.getElementById('btn-next-month').onclick = () => {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            els.calendarTitle.textContent = `${currentMonth.getFullYear()}ÎÖÑ ${currentMonth.getMonth() + 1}Ïõî`;
            renderCalendar(); renderRanking(); updateStats();
        };

        document.getElementById('btn-close-modal').onclick = () => els.modal.classList.add('hidden');

        els.btnSave.onclick = async () => {
            if (!currentUser || !selectedDateStr) return;
            const dist = parseFloat(els.inputDistance.value) || 0;
            const attr = els.inputAttendance.checked;
            
            const payload = {
                distance: dist,
                attendance: !!attr,
                userName: currentUser,
                date: selectedDateStr,
                updatedAt: new Date().toISOString()
            };

            try {
                // Ï†ÄÏû• Î≤ÑÌäº ÏãúÍ∞Å ÌîºÎìúÎ∞±: Ï†ÄÏû• Ï§ë
                els.btnSave.disabled = true;
                els.btnSave.classList.replace('bg-blue-600', 'bg-slate-400');
                els.btnSave.textContent = "Ï†ÄÏû• Ï§ë...";
                
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'records', `${currentUser}_${selectedDateStr}`);
                await setDoc(docRef, payload);
                
                // ÏÑ±Í≥µ ÌîºÎìúÎ∞±: Ï†ÄÏû• ÏôÑÎ£å!
                els.btnSave.classList.replace('bg-slate-400', 'bg-emerald-500');
                els.btnSave.textContent = "Ï†ÄÏû• ÏôÑÎ£å!";
                
                // 0.5Ï¥à Îí§ ÏûêÎèôÏúºÎ°ú ÌôîÎ©¥ Îã´Í∏∞
                setTimeout(() => {
                    els.modal.classList.add('hidden');
                    
                    // Îã§Ïùå ÏûÖÎ†•ÏùÑ ÏúÑÌï¥ Î≤ÑÌäº Ï¥àÍ∏∞ ÏÉÅÌÉúÎ°ú Î≥µÍµ¨ (Îã´Ìûå Îí§ ÏàòÌñâ)
                    setTimeout(() => {
                        els.btnSave.disabled = false;
                        els.btnSave.classList.remove('bg-emerald-500');
                        els.btnSave.classList.add('bg-blue-600');
                        els.btnSave.textContent = "Í∏∞Î°ù Ï†ÄÏû•ÌïòÍ∏∞";
                    }, 300);
                }, 500);
                
            } catch (err) {
                console.error("Save Error:", err);
                els.btnSave.disabled = false;
                els.btnSave.classList.replace('bg-slate-400', 'bg-red-500');
                els.btnSave.textContent = "Ïã§Ìå®! Îã§Ïãú ÏãúÎèÑ";
                setTimeout(() => {
                    els.btnSave.classList.replace('bg-red-500', 'bg-blue-600');
                    els.btnSave.textContent = "Í∏∞Î°ù Ï†ÄÏû•ÌïòÍ∏∞";
                }, 2000);
            }
        };

        init();
    </script>
</body>
</html>