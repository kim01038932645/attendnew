<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SRT Dì¡° ì¶œì„ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; -webkit-tap-highlight-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<div id="app" class="max-w-md mx-auto min-h-screen flex flex-col">
    <!-- Header -->
    <header class="gradient-bg text-white p-6 rounded-b-3xl shadow-lg">
        <h1 class="text-2xl font-bold text-center">SRT Dì¡° ì¶œì„ë¶€</h1>
        <p class="text-center text-sm opacity-80 mt-1">2026 Season (Jan - Jul)</p>
    </header>

    <!-- Global Month Selector -->
    <div class="px-4 pt-4">
        <div class="flex overflow-x-auto py-2 gap-2 no-scrollbar bg-white rounded-xl shadow-sm px-3 border border-gray-200">
            <button onclick="changeGlobalMonth(1)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="1">1ì›”</button>
            <button onclick="changeGlobalMonth(2)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="2">2ì›”</button>
            <button onclick="changeGlobalMonth(3)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="3">3ì›”</button>
            <button onclick="changeGlobalMonth(4)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="4">4ì›”</button>
            <button onclick="changeGlobalMonth(5)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="5">5ì›”</button>
            <button onclick="changeGlobalMonth(6)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="6">6ì›”</button>
            <button onclick="changeGlobalMonth(7)" class="month-btn-global flex-shrink-0 px-4 py-1 rounded-full border text-xs" data-m="7">7ì›”</button>
        </div>
    </div>

    <main class="flex-grow p-4 space-y-6">
        <!-- Main Screen -->
        <div id="main-screen" class="space-y-6">
            <section class="glass-card p-6 rounded-2xl shadow-sm border border-gray-200">
                <h2 class="text-lg font-bold mb-4 flex items-center text-gray-800">
                    <span class="mr-2">ğŸ‘¤</span> ë³¸ì¸ í™•ì¸
                </h2>
                <div class="space-y-3">
                    <select id="name-select" class="w-full p-3 border rounded-xl bg-white focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
                        <option value="">ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                    <button onclick="login()" class="w-full gradient-bg text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-transform">
                        ë‚´ ê¸°ë¡ ê´€ë¦¬í•˜ê¸°
                    </button>
                </div>
            </section>

            <!-- Distance Ranking -->
            <section class="glass-card p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">ğŸƒ ì›”ê°„ ê±°ë¦¬ ë­í‚¹ (TOP 8)</h2>
                    <span class="current-month-display text-sm font-medium text-blue-600">1ì›”</span>
                </div>
                <div id="dist-ranking-list" class="space-y-2">
                    <p class="text-gray-400 text-center py-4 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </section>

            <!-- Attendance Ranking -->
            <section class="glass-card p-6 rounded-2xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold text-gray-800">ğŸ“… ì›”ê°„ ì¶œì„ ë­í‚¹ (TOP 8)</h2>
                    <span class="current-month-display text-sm font-medium text-green-600">1ì›”</span>
                </div>
                <div id="attr-ranking-list" class="space-y-2">
                    <p class="text-gray-400 text-center py-4 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </section>
        </div>

        <!-- Detail Screen -->
        <div id="detail-screen" class="hidden space-y-4">
            <button onclick="showMain()" class="text-blue-600 font-medium flex items-center mb-2 text-sm">
                â† ë©”ì¸ í™”ë©´ìœ¼ë¡œ
            </button>
            
            <section class="glass-card p-5 rounded-2xl shadow-sm border border-gray-200 sticky top-2 z-10">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 id="user-welcome" class="text-lg font-bold text-gray-800">ë‹˜ ê¸°ë¡</h2>
                        <p class="text-[10px] text-gray-400">ê±°ë¦¬ëŠ” ë§¤ì¼, ì¶œì„ì€ ìˆ˜/ì¼ë§Œ ê°€ëŠ¥</p>
                    </div>
                    <div class="text-right">
                        <p class="text-[10px] text-gray-500 font-bold">MY TOTAL</p>
                        <p id="user-total-dist" class="text-xl font-bold text-blue-600">0 km</p>
                    </div>
                </div>
            </section>

            <!-- Daily Entry List -->
            <div id="daily-list" class="space-y-2 pb-10">
                <!-- Days injected here -->
            </div>
        </div>
    </main>

    <!-- Footer Status -->
    <div id="status-bar" class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm px-4 py-2 text-center text-[10px] text-gray-400 border-t z-50">
        ì—°ê²° ì¤‘...
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const members = ["ê°•ë™í˜„", "ê°•ë™í›ˆ", "ì†¡ì±„í•œ", "ê¹€ë¯¸í™”", "ê¹€ì¬ì‚°", "ê¹€ì°¬ì„", "ê¹€í•œë‚˜", "ë¥˜ì§€ì°¬", "ë°•ì„±í™˜", "ë°•ì¢…ë´‰", "ì†Œë³‘ë“", "ì„œì •í™”", "ì‹ ì˜ì„­", "ì•ˆì§€í›ˆ", "ì˜¤í•œì²œ", "ì´ìŠ¹ì¤€", "ì´ìš©êµ¬", "ì •ë•ìˆ˜", "ì£¼íš¨ì„", "ì„œì¸ìˆ˜", "ë°•ì°½ì„ ", "ê¹€ë³‘ì‹"];
    
    const firebaseConfig = {
  apiKey: "AIzaSyBBP8vP90bOisbNlDpsp64k3hxLZw7x2JE",
  authDomain: "attendnew-63c66.firebaseapp.com",
  databaseURL: "https://attendnew-63c66-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "attendnew-63c66",
  storageBucket: "attendnew-63c66.firebasestorage.app",
  messagingSenderId: "992717620682",
  appId: "1:992717620682:web:5ee93256b2a5172d72fb33"
};
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'srt-d-group-checkin';

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let selectedName = "";
    let globalData = {};
    let viewMonth = new Date().getMonth() + 1;
    if(viewMonth > 7) viewMonth = 1;

    const nameSelect = document.getElementById('name-select');
    const mainScreen = document.getElementById('main-screen');
    const detailScreen = document.getElementById('detail-screen');
    const statusBar = document.getElementById('status-bar');

    members.sort().forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = m;
        nameSelect.appendChild(opt);
    });

    async function initAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        } catch (e) {
            statusBar.textContent = "ì—°ê²° ì˜¤ë¥˜";
        }
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            statusBar.textContent = "ì‹¤ì‹œê°„ ì—°ë™ ì™„ë£Œ";
            listenToData();
        }
    });

    function listenToData() {
        if (!currentUser) return;
        const publicDataRef = doc(db, 'artifacts', appId, 'public', 'data', 'records', 'global');
        
        onSnapshot(publicDataRef, (docSnap) => {
            globalData = docSnap.exists() ? docSnap.data() : {};
            renderRankings();
            if (!detailScreen.classList.contains('hidden')) renderDetail();
        }, (err) => {
            statusBar.textContent = "ë°ì´í„° ë¡œë”© ì˜¤ë¥˜";
        });
    }

    window.changeGlobalMonth = (m) => {
        viewMonth = m;
        renderRankings();
        if (!detailScreen.classList.contains('hidden')) renderDetail();
    };

    function renderRankings() {
        const monthKey = `m2026_${viewMonth}`;
        const distRank = [];
        const attrRank = [];

        document.querySelectorAll('.current-month-display').forEach(el => el.textContent = `${viewMonth}ì›”`);
        document.querySelectorAll('.month-btn-global').forEach(btn => {
            if (parseInt(btn.dataset.m) === viewMonth) {
                btn.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            } else {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
            }
        });

        members.forEach(m => {
            const userData = globalData[m] || {};
            const monthData = userData[monthKey] || {};
            let totalDist = 0;
            let attendCount = 0;

            Object.keys(monthData).forEach(date => {
                const dayInfo = monthData[date] || {};
                if (dayInfo.checked) attendCount++;
                totalDist += parseFloat(dayInfo.dist || 0);
            });

            distRank.push({ name: m, val: totalDist });
            attrRank.push({ name: m, val: attendCount });
        });

        const topDist = [...distRank].sort((a, b) => b.val - a.val).slice(0, 8);
        const topAttr = [...attrRank].sort((a, b) => b.val - a.val).slice(0, 8);

        document.getElementById('dist-ranking-list').innerHTML = topDist.map((item, idx) => `
            <div class="flex items-center justify-between p-2 ${idx < 3 ? 'bg-blue-50/50' : ''} rounded-lg border-b border-gray-50 last:border-0">
                <div class="flex items-center">
                    <span class="w-6 text-center font-bold text-xs ${idx === 0 ? 'text-yellow-500' : idx === 1 ? 'text-slate-400' : idx === 2 ? 'text-amber-600' : 'text-gray-300'}">${idx + 1}</span>
                    <span class="text-sm font-medium ml-2 text-gray-700">${item.name}</span>
                </div>
                <span class="text-sm font-bold text-blue-600">${item.val.toFixed(1)}<span class="text-[10px] ml-0.5">km</span></span>
            </div>
        `).join('');

        document.getElementById('attr-ranking-list').innerHTML = topAttr.map((item, idx) => `
            <div class="flex items-center justify-between p-2 ${idx < 3 ? 'bg-green-50/50' : ''} rounded-lg border-b border-gray-50 last:border-0">
                <div class="flex items-center">
                    <span class="w-6 text-center font-bold text-xs text-gray-300">${idx + 1}</span>
                    <span class="text-sm font-medium ml-2 text-gray-700">${item.name}</span>
                </div>
                <span class="text-sm font-bold text-green-600">${item.val}<span class="text-[10px] ml-0.5 text-green-500">íšŒ</span></span>
            </div>
        `).join('');
    }

    window.login = () => {
        const name = nameSelect.value;
        if (!name) { alert("ì´ë¦„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
        selectedName = name;
        mainScreen.classList.add('hidden');
        detailScreen.classList.remove('hidden');
        document.getElementById('user-welcome').textContent = `${selectedName}ë‹˜`;
        renderDetail();
        window.scrollTo(0,0);
    };

    window.showMain = () => {
        detailScreen.classList.add('hidden');
        mainScreen.classList.remove('hidden');
        window.scrollTo(0,0);
    };

    function renderDetail() {
        const monthKey = `m2026_${viewMonth}`;
        const userData = globalData[selectedName] || {};
        const monthData = userData[monthKey] || {};

        let totalMonthly = 0;
        Object.keys(monthData).forEach(dk => {
            totalMonthly += parseFloat(monthData[dk].dist || 0);
        });
        document.getElementById('user-total-dist').textContent = `${totalMonthly.toFixed(1)} km`;

        const dailyList = document.getElementById('daily-list');
        dailyList.innerHTML = "";
        
        const year = 2026;
        const startDate = new Date(year, viewMonth - 1, 1);
        const endDate = new Date(year, viewMonth, 0);

        for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
            const day = d.getDay();
            const dateStr = d.toISOString().split('T')[0];
            const dayInfo = monthData[dateStr] || { checked: false, dist: 0 };
            const isMeetingDay = (day === 0 || day === 3);
            
            const dayCard = document.createElement('div');
            dayCard.className = `glass-card p-3 rounded-xl border flex items-center justify-between ${isMeetingDay ? 'border-blue-200 bg-blue-50/30' : 'border-gray-100'}`;
            
            dayCard.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="text-center w-8">
                        <p class="text-[9px] ${day === 0 ? 'text-red-500' : day === 6 ? 'text-blue-400' : 'text-gray-400'} font-bold">
                            ${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][day]}
                        </p>
                        <p class="font-bold text-base leading-tight">${d.getDate()}</p>
                    </div>
                    <div class="flex items-center bg-white border rounded-lg px-2 py-1">
                        <input type="number" step="0.1" placeholder="0" 
                            value="${dayInfo.dist || ''}"
                            class="w-10 text-sm font-bold text-center outline-none bg-transparent"
                            onchange="saveEntry('${dateStr}', this.value, ${dayInfo.checked})">
                        <span class="text-[10px] text-gray-400 ml-1">km</span>
                    </div>
                </div>
                ${isMeetingDay ? `
                    <button onclick="toggleAttend('${dateStr}', ${dayInfo.dist}, ${!dayInfo.checked})" 
                        class="px-4 py-2 rounded-lg text-xs font-bold transition-all ${dayInfo.checked ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-500'}">
                        ${dayInfo.checked ? 'ì¶œì„ì™„ë£Œ' : 'ì¶œì„ì²´í¬'}
                    </button>
                ` : `
                    <span class="text-[10px] text-gray-300 mr-2 font-medium italic">Daily Record</span>
                `}
            `;
            dailyList.appendChild(dayCard);
        }
    }

    window.saveEntry = async (dateStr, dist, checked) => {
        if (!currentUser) return;
        const monthKey = `m2026_${viewMonth}`;
        const updatePath = `${selectedName}.${monthKey}.${dateStr}`;
        
        statusBar.textContent = "ì €ì¥ ì¤‘...";
        try {
            const publicDataRef = doc(db, 'artifacts', appId, 'public', 'data', 'records', 'global');
            const snap = await getDoc(publicDataRef);
            const entry = { dist: parseFloat(dist) || 0, checked: Boolean(checked) };
            
            if (!snap.exists()) {
                await setDoc(publicDataRef, { [selectedName]: { [monthKey]: { [dateStr]: entry } } });
            } else {
                await updateDoc(publicDataRef, { [updatePath]: entry });
            }
            statusBar.textContent = "ì €ì¥ ì™„ë£Œ";
        } catch (e) {
            statusBar.textContent = "ì €ì¥ ì˜¤ë¥˜";
        }
    };

    window.toggleAttend = (dateStr, dist, newChecked) => {
        window.saveEntry(dateStr, dist, newChecked);
    };

    initAuth();
</script>
</body>
</html>